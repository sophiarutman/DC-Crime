---
title: "5100project"
output: html_document
date: "2024-11-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
data<- read.csv("/Users/zp/Desktop/arrests_2013-2023.csv")
```

changing arrest date to unified format
```{r}
data$Arrest.Date <- ifelse(grepl("^\\d{4}-\\d{2}-\\d{2}$", data$Arrest.Date), 
                           data$Arrest.Date, 
                           format(as.Date(data$Arrest.Date, format = "%m/%d/%Y"), "%Y-%m-%d"))

data$Arrest.Date <- ifelse(grepl("^00\\d{2}-\\d{2}-\\d{2}$", data$Arrest.Date), 
                           sub("^00", "20", data$Arrest.Date), # Replace '00' with '20'
                           data$Arrest.Date)
data$Arrest.Date<- as.Date(data$Arrest.Date)
d1<- data
```

```{r}
#subset data
arrest<- data
arrest<- arrest[c(2,3,7,13,14)]
# assign age group
library(dplyr)
arrest  <- arrest %>%
  mutate(age.group = case_when(
    Age <= 25 ~ "18-25",
    Age >25 & Age <= 30 ~ "26-30",
    Age>30 & Age <=35 ~ "31-35",
    Age >35 & Age <=45 ~ "36-45",
    Age >45 & Age <= 55 ~ "46-55",
    Age >55 & Age <=65 ~ "56-65",
    Age >65 ~"66+"
    
  ))
arrest<- arrest[!is.na(arrest$Arrest.Category),]

before_covid<- arrest[arrest$Arrest.Year<= 2018,]
covid<- arrest[arrest$Arrest.Year>2018,]

```
group it by crime arrest category
violent crime: one has following keyword: Assault|Robbery|Violence|Weapon|Homicide|Kidnapping
property crime: one has following keyword: Damage|Burglary|Theft|Arson|Property
traffic crime: one has following keyword: Traffic
family,sex related crime: one has following keyword: Family|Sex
Drug crime: one has following keyword: Drug|Narcotics|Intoxicated
release crime: one has following keyword: Release
other crime: one has following keyword: other crime not listed 
```{r}
arrest <- arrest %>%
  mutate(Crime.Group = case_when(
    grepl("Assault|Robbery|Violence|Weapon|Homicide|Kidnapping", Arrest.Category, ignore.case = TRUE) ~ "Violent Crime",
    grepl("Damage|Burglary|Theft|Arson|Property", Arrest.Category, ignore.case = TRUE) ~ "Property Crime",
    grepl("Traffic", Arrest.Category, ignore.case = TRUE) ~ "Traffic crime",
    grepl("Family|Sex", Arrest.Category, ignore.case = TRUE) ~ "Family,sex related crime",
    grepl("Drug|Narcotics|Intoxicated", Arrest.Category, ignore.case = TRUE) ~ "Drug Crime",
    grepl("Release", Arrest.Category, ignore.case = TRUE) ~ "Release Violations",
    TRUE ~ "Other Crimes"
  ))

```
divide data into age group
```{r}
age_groups <- split(arrest, arrest$age.group)


age_18_25 <- age_groups[["18-25"]]
age_26_30 <- age_groups[["26-30"]]
age_31_35 <- age_groups[["31-35"]]
age_36_45 <- age_groups[["36-45"]]
age_46_55 <- age_groups[["46-55"]]
age_56_65 <- age_groups[["56-65"]]
age_66_plus <- age_groups[["66+"]]
```

markov chain analysis:
for all age group(7, manually divided),proability for transition to other crimes(divide into crime groups manually)
```{r}
transition_matrix <- function(group_data) {
  # Order input data by arrest date
  group_data <- group_data[order(group_data$Arrest.Date), ]
  
  # Initialize the Next.Crime.Group column
  group_data$Next.Crime.Group <- NA

  # using index to set next crime, next crime must be at least one day, some crime are in same day
  indexing <- which(group_data$Arrest.Date[-1] > group_data$Arrest.Date[-nrow(group_data)])
  
  # use index to assign next crime group from before
  group_data$Next.Crime.Group[indexing] <- group_data$Crime.Group[indexing + 1]
  
  # filtering rows that both crime group and next crime group are not NA
  transitions <- group_data[!is.na(group_data$Crime.Group) & !is.na(group_data$Next.Crime.Group), ]
  
  # get crime group that i set it before and name as crime type
  crime_types <- unique(c(transitions$Crime.Group, transitions$Next.Crime.Group))
  
  # creating matrix initializing with 0
  transition_matrix <- matrix(0, nrow = length(crime_types), ncol = length(crime_types),
                              dimnames = list(crime_types, crime_types))
  
  #use for loop to assign value for transition matrix
  for (i in 1:nrow(transitions)) {
    from <- transitions$Crime.Group[i]
    to <- transitions$Next.Crime.Group[i]
    transition_matrix[from, to] <- transition_matrix[from, to] + 1
  }
  
  # Convert counts to probabilities by dividing by row sums
  row_totals <- rowSums(transition_matrix)
  transition_matrix <- sweep(transition_matrix, 1, row_totals, "/")
  

  return(transition_matrix)
}

```

```{r}
mat1<-transition_matrix(age_18_25)
mat2<-transition_matrix(age_26_30)
mat3<-transition_matrix(age_31_35)
mat4<-transition_matrix(age_36_45)
mat5<-transition_matrix(age_46_55)
mat6<-transition_matrix(age_56_65)
mat7<-transition_matrix(age_66_plus)

```

```{r}
library(reshape2)
library(ggplot2)


visualize<- function(transition_matrix,age_group) {
  transition_mat <- as.data.frame.matrix(transition_matrix)
  transition_mat$Crime.Group <- rownames(transition_mat)
  transition_mat <- melt(transition_mat, id.vars = "Crime.Group")
  
  colnames(transition_mat) <- c("Current.Crime", "Next.Crime", "Probability")
  
  ggplot(transition_mat, aes(x = Next.Crime, y = Current.Crime, fill = Probability)) +
    geom_tile(color = "white") +
    geom_text(aes(label = round(Probability, 2)), color = "black", size = 3) +
    scale_fill_gradient(low = "skyblue", high = "orange", name = "Transition\nProbability", limits = c(0, 1)) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1,size = 10)) +
    labs(title = paste("Crime Type Transition Probabilities for Age Group:", age_group), 
         x = "Next Crime Group", 
         y = "Current Crime Group")
}
```


```{r}
visualize(mat1,"18-25")
visualize(mat2,"26-30")
visualize(mat3,"31-35")
visualize(mat4,"36-45")
visualize(mat5,"46-55")
visualize(mat6,"56-65")
visualize(mat7,"66 or more")
```


hypothesis testing: age analysis
h0: there is a no difference in average age of individual arrestee for crime types before 
and after covid19
h1:there is a difference in average of age individual arrestee for crime types before 
and after covid19
using anova
```{r}
covid_crime<- arrest
covid_crime$covid<-NA 
covid_crime<-  covid_crime %>%
  mutate(covid= case_when(
    Arrest.Year<2019 ~ "before covid",
    Arrest.Year>2018 ~"after covid"
  ))

# fraud and financial crime and release violation has multiple values, not all of 
#same category appears in both covid and before covid, so need to unify
covid_crime <- covid_crime %>%
  mutate(Arrest.Category = case_when(
    grepl("Fraud and Financial Crime", Arrest.Category, ignore.case = TRUE) ~ "Fraud and Financial Crimes",
    grepl("Release Violations", Arrest.Category, ignore.case = TRUE) ~ "Release Violations",
    TRUE ~ Arrest.Category
  ))
anova_results <- covid_crime %>%
  group_by(Arrest.Category) %>%
  summarise(
    F_statistic = summary(aov(Age ~ covid))[[1]]$`F value`[1],
    P_value = summary(aov(Age ~ covid))[[1]]$`Pr(>F)`[1]
  )
significant_results <- anova_results %>%
  filter(P_value < 0.05)
significant_results
```

```{r}

```




```{r}
levels_check <- covid_crime %>%
  group_by(Arrest.Category)%>%
  summarise(levels_count = n_distinct(covid))
```



```{r}
write.csv(covid,"/Users/zp/Desktop/covid.csv")
write.csv(before_covid,"/Users/zp/Desktop/before_covid.csv")
```

